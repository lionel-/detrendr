---
title: "Detrending images with `detrendr`"
author: "Rory Nolan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{detrendr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Detrend image series.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "#>")
```

First let's load the library: 
```{r load}
library(detrendr)
```

## Image I/O and display
The package contains convenient functions for reading and writing TIFF files. It also contains a sample image series which can be found at `system.file("extdata", "cells.tif", package = "detrendr")`. Let's read it in and display the first and last frames:
```{r display}
path <- system.file("extdata", "bleached.tif", package = "detrendr")
img <- read_tif(path)
dim(img)  # img has 500 frames
display(img[, , 1],  # first frame
        breaks = 0:500, col = grDevices::grey(seq(0, 1, length.out = 500)))
display(img[, , 500],  # last frame
        breaks = 0:500, col = grDevices::grey(seq(0, 1, length.out = 500)))
```

## Detrending
We see that the intensity is much lower for the last frame, this is because the image series has been bleached. This can be further seen with a plot of the frame means:
```{r frame means}
plot(apply(img, 3, mean), ylim = c(60, 150))
```

We can correct for this (and check how long it takes):
```{r detrend}
system.time(corrected_exp <- img_detrend_exp(img, "auto", 
                                             seed = 0, parallel = 2))["elapsed"]
display(corrected_exp[, , 1],  # first frame
        breaks = 0:500, col = grDevices::grey(seq(0, 1, length.out = 500)))
display(corrected_exp[, , 500],  # last frame
        breaks = 0:500, col = grDevices::grey(seq(0, 1, length.out = 500)))
```

So we see that the corrected series does not have this drop-off in intensity. 
```{r corrected frame means}
plot(apply(corrected_exp, 3, mean), ylim = c(60, 150))
```

Above we used *exponential filtering* detrending, but we could also use *boxcar* or *polynomial*. 
```{r boxcar and polynom}
system.time(corrected_boxcar <- img_detrend_boxcar(img, "auto", 
                                  seed = 0, parallel = 2))["elapsed"]
system.time(corrected_polynom <- img_detrend_polynom(img, "auto", 
                                   seed = 0, parallel = 2))["elapsed"]
```

Let's check the mean brightness of each:
```{r compare brightnesses}
mean(brightness_pillars(corrected_exp))
mean(brightness_pillars(corrected_boxcar))
mean(brightness_pillars(corrected_polynom))
```

So we see that different methods give different results.
